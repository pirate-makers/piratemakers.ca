<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Prune">
<meta name="description" content="Recap I already talked about Istio &#43; Cert-Manager in part one and part two. In the meantime Istio went to release 1.0, lastly 1.0.3.
While this version improves a lot of things and finally get rid of some nasty bugs when using gRPC (HTTP2) Streams, there’s still no improvement on the Ingress Gateway SSL Management.
Let me remind you :
Cert-Manager only create TLS Secrets, which are a kind of Secret that only contains a crt and key file." />
<meta name="keywords" content="blog,developer,personal,cnc,shapeoko,maker,pirate,hacker,go,golang,devops,gitops, devops, servicemesh, kubernetes, dev, golang" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/" />


    <title>
        
            Istio 1.0.2 (Envoy) &#43; Cert-Manager &#43; Let’s Encrypt for TLS &#43; Certificate Merge :: Pirate Makers 
        
    </title>





<link rel="stylesheet" href="https://piratemakers.ca/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE=">


    
        <link rel="stylesheet" type="text/css" href="https://piratemakers.ca/css/custom.css">
    


    <link rel="apple-touch-icon" sizes="180x180" href="https://piratemakers.ca/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://piratemakers.ca/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://piratemakers.ca/favicon-16x16.png">
    <link rel="manifest" href="https://piratemakers.ca/site.webmanifest">
    <link rel="mask-icon" href="https://piratemakers.ca/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://piratemakers.ca/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Istio 1.0.2 (Envoy) &#43; Cert-Manager &#43; Let’s Encrypt for TLS &#43; Certificate Merge">
<meta itemprop="description" content="Recap I already talked about Istio &#43; Cert-Manager in part one and part two. In the meantime Istio went to release 1.0, lastly 1.0.3.
While this version improves a lot of things and finally get rid of some nasty bugs when using gRPC (HTTP2) Streams, there’s still no improvement on the Ingress Gateway SSL Management.
Let me remind you :
Cert-Manager only create TLS Secrets, which are a kind of Secret that only contains a crt and key file."><meta itemprop="datePublished" content="2018-11-07T17:38:31+00:00" />
<meta itemprop="dateModified" content="2023-12-01T14:31:59-05:00" />
<meta itemprop="wordCount" content="3353"><meta itemprop="image" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/images/1.jpeg" /><meta itemprop="image" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/images/2.png" />
<meta itemprop="keywords" content="devops,servicemesh,kubernetes,dev,golang," />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/images/1.jpeg" /><meta name="twitter:title" content="Istio 1.0.2 (Envoy) &#43; Cert-Manager &#43; Let’s Encrypt for TLS &#43; Certificate Merge"/>
<meta name="twitter:description" content="Recap I already talked about Istio &#43; Cert-Manager in part one and part two. In the meantime Istio went to release 1.0, lastly 1.0.3.
While this version improves a lot of things and finally get rid of some nasty bugs when using gRPC (HTTP2) Streams, there’s still no improvement on the Ingress Gateway SSL Management.
Let me remind you :
Cert-Manager only create TLS Secrets, which are a kind of Secret that only contains a crt and key file."/>



    <meta property="og:title" content="Istio 1.0.2 (Envoy) &#43; Cert-Manager &#43; Let’s Encrypt for TLS &#43; Certificate Merge" />
<meta property="og:description" content="Recap I already talked about Istio &#43; Cert-Manager in part one and part two. In the meantime Istio went to release 1.0, lastly 1.0.3.
While this version improves a lot of things and finally get rid of some nasty bugs when using gRPC (HTTP2) Streams, there’s still no improvement on the Ingress Gateway SSL Management.
Let me remind you :
Cert-Manager only create TLS Secrets, which are a kind of Secret that only contains a crt and key file." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/" /><meta property="og:image" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/images/1.jpeg" /><meta property="og:image" content="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/images/2.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-11-07T17:38:31+00:00" />
<meta property="article:modified_time" content="2023-12-01T14:31:59-05:00" />







    <meta property="article:published_time" content="2018-11-07 17:38:31 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://piratemakers.ca/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                Pirate Makers</span>
            <span class="logo__cursor" style=
                  "visibility:hidden;
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://piratemakers.ca/posts/">Blog</a></li><li><a href="https://piratemakers.ca/about/">About</a></li><li><a href="https://piratemakers.ca/tags">Tags</a></li>
        <div class="submenu">
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">en</a>
                <div class="dropdown-content">
                    
                        
                    
                </div>
            </li>
        </div>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
            Published 2018-11-07
  
           
            
              (Last updated: 2023-12-01)
            
          
      </p>
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        16 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://piratemakers.ca/posts/2018/11/istio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge/">Istio 1.0.2 (Envoy) + Cert-Manager + Let’s Encrypt for TLS + Certificate Merge</a>
      </h1>

      

      

      

      <div class="post-content">
        <p><img src="images/1.jpeg#layoutTextWidth" alt="image"></p>
<h3 id="recap">Recap</h3>
<p>I already talked about Istio + Cert-Manager in <a href="https://medium.com/@prune998/istio-envoy-cert-manager-lets-encrypt-for-tls-14b6a098f289">part one</a> and <a href="https://medium.com/@prune998/istio-0-8-0-envoy-cert-manager-lets-encrypt-for-tls-d26bee634541">part two</a>. In the meantime Istio went to release 1.0, lastly 1.0.3.</p>
<p>While this version improves a lot of things and finally get rid of some nasty bugs when using gRPC (HTTP2) Streams, there’s still no improvement on the Ingress Gateway SSL Management.</p>
<p>Let me remind you :</p>
<ul>
<li>Cert-Manager only create <strong>TLS Secrets</strong>, which are a kind of Secret that only contains a <strong>crt</strong> and <strong>key</strong> file.</li>
<li>Istio Ingress Gateway only mount <strong>ONE Secret</strong> named <em>istio-ingressgateway-certs.</em></li>
<li>Istio Ingress Gateway have no way to detect when a SSL Certificate is updated.</li>
</ul>
<p>This three constraints lead to the fact that :</p>
<ul>
<li>you can only create ONE <strong>Certificate</strong> Resource with all your endpoints in it</li>
<li>the target <strong>TLS Secret</strong> have to be located in the Istio-System Namespace</li>
<li>You can’t mix certificates created from Cert-Manager and another source (like providing your own Certificates for some domains)</li>
</ul>
<h3 id="what-solutions-do-we-have-">What solutions do we have ?</h3>
<p>Well, not much right now.</p>
<p>Cert-Manager’s team is looking into this and will change/stabilize the API <em>soon</em>, which should offer other ways to store Secrets, like Ashicorp Vault.<br>
When I say <em>soon</em>, it’s more of a joke than a close event. I opened a discussion months ago and went almost to a PR to allow Cert-Manager to be able to write multiple Certificates inside a single Secret, changing their type from TLS to Opaque. Following the discussion I did not push the PR. I was told that :</p>
<blockquote>
<p>We can’t accept a PR like this as we are trying to stabilize the API and the final storage for Certificates is not yet decided. Also, we have to be careful not to include things in the API that we couldn’t support in the long term.</p>
</blockquote>
<p>Istio is also looking for a solution to use something else than Secrets, of have something else manage the secrets for you. As of now, Istio (and the Ingress Gateway) do not support automatic update when a Secret is updated.</p>
<h3 id="then-enter-cert-merge-operator">Then enter Cert-Merge Operator</h3>
<p>I was so much frustrated about all this that I came with my own solution : <a href="https://github.com/prune998/certmerge-operator">Cert-Merge Operator</a>!</p>
<p>Be warned : this is my first time using the <a href="https://github.com/operator-framework/operator-sdk">Operator SDK</a> and this is Beta software. Still, I just put it in Production on our platform.</p>
<p>The idea is simple : as Istio can only read <em>ONE Secret</em> to fetch <em>Certificates</em> and since Cert-Manager can only set <em>ONE certificate</em> in each <em>Secret</em>, we need a way to <strong>merge many TLS Secret’s data into one Opaque Secret with many Certificates.</strong></p>
<p>So, how does this work ? Let’s find out…</p>
<p><img src="images/2.png#layoutTextWidth" alt="image"></p>
<ol>
<li>The user push Manifests to create some <em>Certificates</em></li>
<li><strong>Cert-Manager</strong> is triggered and create to corresponding TLS Secrets</li>
<li><strong>CertMerge Operator</strong> watch for Secrets and is triggered when Cert-Manager create or update them</li>
<li><strong>CertMerge Operator</strong> also watch for <em>CertMerge</em> requests. In our case, we decided to merge ALL certificates with a Label <em>certmerge=true</em> into ONE SINGLE <em>Opaque Secret.</em>
This is due to Istio limitation to only mount one secret inside the Ingress Gateway.</li>
<li><strong>CertMerge Operator</strong> create the Istio’s needed Secret</li>
<li>the <strong>Istio Ingress Gateway</strong> watch for <em>Gateway</em> Resources. Each <em>Gateway</em> is defined to use a different certificate name (coming from the same single Secret which is mounted at start)</li>
</ol>
<h3 id="can-i-do-that-in-prod-">Can I do that in Prod ?</h3>
<p>Well, while it’s working on our platform, there still are some possible issues :</p>
<p>First, this solution needs you to have a <strong>Label</strong> on the Cert-Manager’s Secret.<br>
This <strong>Label</strong> is used by the Cert-Merge Operator to search/select the secrets that needs to be merged. This not supported at the moment.<br>
It’s also why I’m pissed off by Cert-Manager project.</p>
<p>Short explanation : I opened an <a href="https://github.com/jetstack/cert-manager/issues/977">issue</a>, then a <a href="https://github.com/jetstack/cert-manager/pull/1027">PR</a>, to add support for Labels in the Certificate Custom Resource.<br>
This PR was rejected with almost the same statement I had months before :</p>
<blockquote>
<p>So at the moment there’s open questions around how we can define alternate representations of certificates (i.e. as a secret, as a field on another resource, or even being stored in other secret backends). We need to work out how these sorts of things will be represented before we accept new fields on our API resources that may in future be difficult to maintain.&gt; For that reason, I don’t think we can accept this PR for the time being.</p>
</blockquote>
<p>Well, you can go read the whole thread, but as far as I’m concerned, there ALREADY is a v1 API for Cert-Manager, and whatever is done, there WILL BE A v2 anytime soon. So, instead of improving V1 right now and maybe change it in V2, they prefer waiting for V2.</p>
<p>I already waited too many years of my life…</p>
<ul>
<li>for a girlfriend which dumped me after 5 years</li>
<li>for the new Iphone XS which would be faster than the X (which is, but have smaller battery)</li>
<li>for a real summer in Quebec City</li>
<li>for the next Macpro which never came (don’t call the trashcan a Macpro !)</li>
</ul>
<p>I will not wait for a CNCF Project to stop improving on V1 while they try to settle on V2.</p>
<p>So, to conclude : <strong>NO YOU CAN’T !</strong></p>
<p>As suggested by the Cert-Manager’s involved people, you CAN pre-create the <code>Secrets</code> with the desired names and add <code>Labels</code>. Cert-Manager will add the SSL Cert’s data afterward. (never tested this)</p>
<p>Well, again, I’m questioning these guy’s production knowledge. The whole point of all this is automation. I create a <code>Certificate</code> CR and I get a <code>Secret</code> with the certificate. If I have to create the <code>Secret</code> before uploading the <code>Certificate</code> CR, I would rather create the crt and key files on my own and upload them into the <code>Secret</code>.</p>
<h3 id="i-still-want-it-">I still want it !</h3>
<p>Notice : <em>It’s beta, it does not work with stock Cert-Manager, it may change in the future.</em></p>
<p>So if you still want to use it, you have to build your own Cert-Manager with my PR applied. You can clone from my <a href="https://github.com/prune998/cert-manager/tree/prune/certificate-labels">Github repo</a>.</p>
<p>Also, note that there MAY BE some security concerns using the CertMerge Operator… Be conscious that you are giving the right to an Operator to read ALL the Secrets in your Kubernetes cluster and potentially merge them into another Namespace.</p>
<p>I’m pretty sure LOTS of people will have to complain about that.</p>
<p>I still have to figure out the real workflow here…<br>
Should I just manage Secrets from within the Istio-System Namespace ?<br>
Should I only be able to merge Secrets from a Namespace into the same Namespace ?</p>
<h3 id="what-about-the-operator-sdk-">What about the Operator SDK ?</h3>
<p>Well, I got this Operator setup and running, starting from almost 0, in few hours coding. So I think we can say it’s a really cool and fast path to creating Operators.<br>
I also had [great support from the community] (<a href="https://github.com/operator-framework/operator-sdk/issues/694)when">https://github.com/operator-framework/operator-sdk/issues/694)when</a> I was struggling to add some features.</p>
<p>From my point of view I would have loved a little more examples and docs.</p>
<p>I won’t go through the Operator SDK Cli setup, just follow the <a href="https://github.com/operator-framework/operator-sdk#quick-start">Quick Start</a> of the <a href="https://coreos.com/blog/introducing-operator-framework">Blog Post</a>. I’m just going to explain some of my code.</p>
<p>Once you have the CLI setup you can start creating your Operator. As you’ll see in the QuickStart, you need to create a new Operator, add an API (your Custom Resource) and add a Controler. This is all done using the CLI and will provide a default implementation :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>operator-sdk new certmerge-operator  
</span></span><span style="display:flex;"><span>cd certmerge-operator  
</span></span><span style="display:flex;"><span>operator-sdk add api --api-version<span style="color:#f92672">=</span>certmerge.lecentre.net/v1alpha1 --kind<span style="color:#f92672">=</span>CertMerge  
</span></span><span style="display:flex;"><span>operator-sdk add controller --api-version<span style="color:#f92672">=</span>certmerge.lecentre.net/v1alpha1 --kind<span style="color:#f92672">=</span>CertMerge  
</span></span><span style="display:flex;"><span>operator-sdk generate k8s
</span></span></code></pre></div><p>The last command, <code>operator-sdk generate k8s</code> will generate the needed code from your Custom Resouce Definition so you will have to run it every time you change something.</p>
<h4 id="the-custom-resource">The Custom Resource</h4>
<p>In my case the Custom Resouce is of <code>Type: CertMerge</code> and is defined in <code>pkg/apis/certmerge/v1alpha1/certmerge_types.go</code> .</p>
<p>It must include all the needed fields your Operator will need to do it’s job. You also need a <code>List</code> type of your Resource. Here’s my CR :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CertMerge is the Schema for the certmerges API  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CertMerge</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;```</span>  <span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">CertMergeSpec</span>   <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">CertMergeStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CertMergeList contains a list of CertMerge  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CertMergeList</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;```</span>  <span style="color:#a6e22e">Items</span>           []<span style="color:#a6e22e">CertMerge</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Most important here are that my CR contains a <code>Spec</code>, holding the details of my CR, and a <code>Status</code>, holding the fields that my Operator can use to re-concile the CR. I haven’t add stuff to the Status part of the Operator right now.</p>
<p>The <code>Spec</code> is defined as :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CertMergeSpec defines the desired state of CertMerge``type CertMergeSpec struct {  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">SecretName</span>      <span style="color:#66d9ef">string</span>             <span style="color:#e6db74">`json:&#34;name&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SecretNamespace</span> <span style="color:#66d9ef">string</span>             <span style="color:#e6db74">`json:&#34;namespace&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Selector</span>        []<span style="color:#a6e22e">SecretSelector</span>   <span style="color:#e6db74">`json:&#34;selector&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SecretList</span>      []<span style="color:#a6e22e">SecretDefinition</span> <span style="color:#e6db74">`json:&#34;secretlist&#34;`</span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SecretSelector defines the needed parameters to search for secrets by Label  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SecretSelector</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LabelSelector</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelector</span> <span style="color:#e6db74">`json:&#34;labelselector&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Namespace</span>     <span style="color:#66d9ef">string</span>               <span style="color:#e6db74">`json:&#34;namespace&#34;`</span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SecretDefinition defines the parameters to search for secrets by name  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SecretDefinition</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Namespace</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;namespace&#34;`</span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To define a Merge we need to give it a Name and a Namespace, a list of Secrets to add (SecretList) and a list of Labels to search for (we will include all the certs that match the Labels).</p>
<h4 id="the-main">The Main</h4>
<p>There’s not much in the main. I decided to use <a href="https://github.com/Sirupsen/logrus">Logrus</a> as logger but there are active discussions to change it to <a href="https://github.com/golang/glog">Glog</a> and Zap (but my friend and co-worker Akh is strongly discouraging me to go with Glog) . I added an option to change the Log Level :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">logLevel</span>       = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;loglevel&#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">WarnLevel</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#e6db74">&#34;the log level to display&#34;</span>)  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">displayVersion</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;version&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;Show version and quit&#34;</span>)  
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// set logs in json format  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">myLogLevel</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">ParseLevel</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">logLevel</span>)  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">myLogLevel</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">WarnLevel</span>  
</span></span><span style="display:flex;"><span>  }  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">SetLevel</span>(<span style="color:#a6e22e">myLogLevel</span>)  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">SetFormatter</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">JSONFormatter</span>{}
</span></span></code></pre></div><p>Then you create a Manager which holds all the SDK components :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">mgr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">Options</span>{<span style="color:#a6e22e">Namespace</span>: <span style="color:#e6db74">&#34;&#34;</span>})
</span></span></code></pre></div><p>Using an empty Namespace make the Operator watch ALL Namespaces. You will have to update the RBAC rules for your Operator to allow for this. I’ve changed the Roles/RoleBindings to ClusterRoles/ClusterRoleBindings.</p>
<p>You finally add all APIs and Controlers. These lines will load ALL the files located in the <code>pkg/apis</code> and <code>pkg/controller</code> to the Manager :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Setup Scheme for all resources  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">AddToScheme</span>(<span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetScheme</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Setup all Controllers  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">AddToManager</span>(<span style="color:#a6e22e">mgr</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="the-watch">The Watch</h4>
<p>The Operator watch for some Resources change to trigger a Reconcile. This is done in the <code>Controler</code>. It’s located in the file <code>pkg/controller/certmerge/certmerge_controller.go</code></p>
<p>The <code>Add</code> function is called when we add the Controlers. This function indeed create the Controler and all the Watched. Obviously you want to watch your own Custom Resource (I will use CR now on) :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">mgr</span> <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">Manager</span>, <span style="color:#a6e22e">r</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Reconciler</span>, <span style="color:#a6e22e">mapFn</span> <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">ToRequestsFunc</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create a new controller  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;certmerge-controller&#34;</span>, <span style="color:#a6e22e">mgr</span>, <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Options</span>{<span style="color:#a6e22e">Reconciler</span>: <span style="color:#a6e22e">r</span>})  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>  
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Watch for changes to primary resource CertMerge  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Kind</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">certmergev1alpha1</span>.<span style="color:#a6e22e">CertMerge</span>{}}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">EnqueueRequestForObject</span>{})  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>  
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>If you’re building your own Operator from scratch, your <code>add</code> func is going to take only 2 parameters. The last one, <code>mapFn handler.ToRequestsFunc</code> is a function that will be called by some <code>Watch</code> instead of the default <code>Reconcile</code> function. I’ll get to it soon.</p>
<p>In this Operator, we watch for <code>CertMerge</code> CR and we create/update <code>Secrets</code>. The SDK have a cool way to link the <code>Secrets</code> we create. This allows us, for example, to automatically remove the <code>Secret</code> when the <code>CertMerge</code> is removed.</p>
<p>To do that we create a new <code>Watch</code> with a handler of <code>EnqueueRequestForOwner</code> instead of a <code>EnqueueRequestForObject</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// This will trigger the Reconcile if the Merged Secret is modified
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Kind</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>{}}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">EnqueueRequestForOwner</span>{  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">IsController</span>: <span style="color:#66d9ef">true</span>,  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">OwnerType</span>:    <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">certmergev1alpha1</span>.<span style="color:#a6e22e">CertMerge</span>{},  
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>So now, the Reconcile will be triggered if there is an event regarding a <code>CertMerge</code> resource of a <code>Secret</code> resource that is managed by our Operator.</p>
<p>When Cert-Manager renew a Certificate it will update the target Secret. This event also need to be watched by our Operator. This is done using another kind of <code>Watch</code> : the <code>EnqueueRequestsFromMapFunc</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Watch for Secret change and process them through the SecretTriggerCertMerge function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// This watch enables us to reconcile a CertMerge when a concerned Secret is changed (create/update/delete)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Watch</span>(  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Kind</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>{}},  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">EnqueueRequestsFromMapFunc</span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ToRequests</span>: <span style="color:#a6e22e">mapFn</span>,  
</span></span><span style="display:flex;"><span>  },  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p</span>,  
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>We’re saying here that we will run the <code>mapFn</code> function when a <code>Secret</code> event is triggered.</p>
<p>We also use <code>p</code>, a <code>Predicate</code>. Predicates are used to filter <code>Events</code>. The <code>Predicate</code> function will return <code>true</code> if the event have to be passed to the <code>mapFn</code> function or <code>false</code> to drop the event.</p>
<p>For example, the <code>Delete</code> events are dropped :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">e</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">DeleteEvent</span>) <span style="color:#66d9ef">bool</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>  
</span></span><span style="display:flex;"><span>},
</span></span></code></pre></div><p>We drop <code>Delete</code> events as, when deleting an object, the K8s API first create an<code>Update event</code> with some <code>Delete Metadata</code> then create a <code>Delete event</code>.</p>
<p>In case of an <code>Update</code> event, we don’t want to trigger a <code>Reconcile</code> if the Secret’s data is not changed :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// if old and new data is the same, don&#39;t reconcile  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">newObj</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ObjectNew</span>.<span style="color:#a6e22e">DeepCopyObject</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>)  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">oldObj</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ObjectOld</span>.<span style="color:#a6e22e">DeepCopyObject</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmp</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">newObj</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">oldObj</span>.<span style="color:#a6e22e">Data</span>) {  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I’m still not sure how to only trigger the right events. As the <code>mapFn</code> func only gets access to the latest object (not the old or the diff), it does not know if it’s a create, update or delete operation that triggered the event.<br>
In case of a delete, for example, 2 events are fired : first an <code>Update</code> and then a <code>Delete</code>. During the <code>Delete</code> operation, the Secret is already removed, so the reconcile will fail. The target Merged Secret will not be updated and the now-removed certificate will still be visible inside the Secret.</p>
<p>There’s still work to do to improve all this.</p>
<h3 id="secrets-event-management">Secret’s Event Management</h3>
<p>As stated, a <code>Secret</code> update event will trigger the <code>mapFn</code> func which, in this controller, is <code>SecretTriggerCertMerge</code>.</p>
<p>The purpose of this function is to find all the <code>CertMerge</code> CR that should be reconciled when a <code>Secret</code> is changed.</p>
<p>First thing to do here is to DROP the event if the <code>Secret</code> is/was created by the Operator itself. This case is already taken care by the other Secret’s Watch.</p>
<p>We then get all the <code>CertMerge</code> CR and check if the <code>Secret</code> have a Name or the Labels the CR requires.</p>
<p>If yes, we add the CR to the list and return it. Each CR in the list will trigger a Reconcile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// parse each CertMerge CR and reconcile them if needed  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cm</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">cml</span>.<span style="color:#a6e22e">Items</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">secretInCertMergeList</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">instance</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">secretInCertMergeLabels</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">instance</span>) {  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// trigger the CertMerge Reconcile  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">result</span> = append(<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Request</span>{ <span style="color:#a6e22e">NamespacedName</span>: <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">ObjectKey</span>{<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Name</span>}})
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;CertMerge %s/%s added to Reconcile List&#34;</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Name</span>)  
</span></span><span style="display:flex;"><span>  }  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span></code></pre></div><h4 id="reconcile">Reconcile</h4>
<p>The last part and most important is the Reconcile function.<br>
It is triggered when a<code>CertMerge</code> event occurs and when a <code>Secret</code> event is concerned by a <code>CertMerge</code> CR.</p>
<p>As we merge based on <code>Secret</code> Name and <code>Secret</code> Labels, we have a two pass strategy where we add all concerned <code>Secrets</code> to a list. We finally concat them into a <code>Secret</code> and put in back in K8s using the API.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">secret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newSecretForCR</span>(<span style="color:#a6e22e">instance</span>)  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">certData</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">byte</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">SecretList</span>) &gt; <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">sec</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">SecretList</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">secContent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">searchSecretByName</span>(<span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">Namespace</span>)  
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">certData</span>[<span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">Name</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.crt&#34;</span>] = <span style="color:#a6e22e">secContent</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#e6db74">&#34;tls.crt&#34;</span>]  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">certData</span>[<span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">Name</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.key&#34;</span>] = <span style="color:#a6e22e">secContent</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#e6db74">&#34;tls.key&#34;</span>]  
</span></span><span style="display:flex;"><span>  }  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span>) &gt; <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">sec</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">secContent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">searchSecretByLabel</span>(<span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">LabelSelector</span>.<span style="color:#a6e22e">MatchLabels</span>, <span style="color:#a6e22e">sec</span>.<span style="color:#a6e22e">Namespace</span>)  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">secCert</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">secContent</span>.<span style="color:#a6e22e">Items</span> {  
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">certData</span>[<span style="color:#a6e22e">secCert</span>.<span style="color:#a6e22e">Name</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.crt&#34;</span>] = <span style="color:#a6e22e">secCert</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#e6db74">&#34;tls.crt&#34;</span>]  
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">certData</span>[<span style="color:#a6e22e">secCert</span>.<span style="color:#a6e22e">Name</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.key&#34;</span>] = <span style="color:#a6e22e">secCert</span>.<span style="color:#a6e22e">Data</span>[<span style="color:#e6db74">&#34;tls.key&#34;</span>]  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>  }  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">Data</span> = <span style="color:#a6e22e">certData</span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">secret</span>)
</span></span></code></pre></div><p>Of course this is far more complicated, but check the code, this is just a workflow overview.</p>
<h3 id="using-the-operator">Using the Operator</h3>
<p>If you still think this Operator can suite your needs, deploy it for yourself.</p>
<p>To do so you will find the sample deployment manifests in the <code>deploy</code> folder. You just need to apply them in the right namespace.</p>
<p>This deployment use the <code>:latest</code> image of my public <a href="https://hub.docker.com/r/prune/cert-operator/">Docker Hub Registry</a>.</p>
<p>Quoting the <code>README.md</code> file :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f deploy/namespace.yaml  
</span></span><span style="display:flex;"><span>kubectl -n cert-merge apply -f deploy/service_account.yaml  
</span></span><span style="display:flex;"><span>kubectl -n cert-merge apply -f deploy/role.yaml  
</span></span><span style="display:flex;"><span>kubectl -n cert-merge apply -f deploy/role_binding.yaml  
</span></span><span style="display:flex;"><span>kubectl -n cert-merge apply -f deploy/certmerge_v1alpha1_certmerge_crd.yaml  
</span></span><span style="display:flex;"><span>kubectl -n cert-merge apply -f deploy/operator.yaml
</span></span></code></pre></div><p>Ok you’ve got an operator, now what ?</p>
<h4 id="cert-manager-certificates">Cert-Manager Certificates</h4>
<p>Now that you have the Operator, you can split all your <code>Certificates</code> in different <code>Secrets</code>. This is my first <code>Certificate</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">certmanager.k8s.io/v1alpha1  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Certificate  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cert-svc.dev.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-system  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">acme</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">dns01</span>:  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">provider</span>: <span style="color:#ae81ff">aws-dns-prod  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">domains</span>:  
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">svc.dev.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">commonName</span>: <span style="color:#ae81ff">svc.dev.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsNames</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">svc.dev.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;dev&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">certmerge</span>: <span style="color:#e6db74">&#34;true&#34;</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">issuerRef</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt-prod  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">cert-svc.dev.domain.com  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">organization</span>:  
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">My Own Team</span>
</span></span></code></pre></div><p>Once Cert-Manager job is done I’ll have a new Secret <code>cert-svc.dev.domain.com</code> in the <code>istio-system</code> Namespace.</p>
<p>Let’s add another one :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">certmanager.k8s.io/v1alpha1  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Certificate  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cert-svc.prod.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-system  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">acme</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">dns01</span>:  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">provider</span>: <span style="color:#ae81ff">aws-dns-prod  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">domains</span>:  
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">svc.prod.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">commonName</span>: <span style="color:#ae81ff">svc.prod.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsNames</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">svc.prod.domain.com  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;prod&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">certmerge</span>: <span style="color:#e6db74">&#34;true&#34;</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">issuerRef</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt-prod  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">cert-svc.prod.domain.com  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">organization</span>:  
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">My Own Team</span>
</span></span></code></pre></div><p>Ensure all certificates are generated :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n istio-system get secrets -l certmerge<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                        TYPE                DATA      AGE  
</span></span><span style="display:flex;"><span>cert-svc.dev.domain.com     kubernetes.io/tls   <span style="color:#ae81ff">2</span>         7h  
</span></span><span style="display:flex;"><span>cert-svc.prod.domain.com    kubernetes.io/tls   <span style="color:#ae81ff">2</span>         7h
</span></span></code></pre></div><p>Now Create the Merge. We only need ONE <code>CertMerge</code> CR as Istio can only read ONE <code>Secret</code>. So let’s put everything in it :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">certmerge.lecentre.net/v1alpha1  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CertMerge  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;certmerge-istio-ingress&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">labelselector</span>:  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">matchLabels</span>:  
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">certmerge</span>: <span style="color:#e6db74">&#34;true&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-system  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-ingressgateway-certs  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-system</span>
</span></span></code></pre></div><p>After that, you should have one new <code>Secret</code> called <code>istio-ingressgateway-certs</code>. Let’s check that :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n istio-system describe  secrets istio-ingressgateway-certs  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:         istio-ingressgateway-certs  
</span></span><span style="display:flex;"><span>Namespace:    istio-system  
</span></span><span style="display:flex;"><span>Labels:       certmerge<span style="color:#f92672">=</span>certmerge-istio-ingress  
</span></span><span style="display:flex;"><span>              creator<span style="color:#f92672">=</span>certmerge-operator  
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;<span style="color:#e6db74">``</span>Type:  Opaque<span style="color:#e6db74">``</span>Data  
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>  
</span></span><span style="display:flex;"><span>cert-svc.dev.domain.com.crt     <span style="color:#ae81ff">1675</span> bytes  
</span></span><span style="display:flex;"><span>cert-svc.dev.domain.com.key     <span style="color:#ae81ff">1675</span> bytes  
</span></span><span style="display:flex;"><span>cert-svc.prod.domain.com.crt    <span style="color:#ae81ff">1675</span> bytes  
</span></span><span style="display:flex;"><span>cert-svc.prod.domain.com.key    <span style="color:#ae81ff">1675</span> bytes
</span></span></code></pre></div><p>That’s it !</p>
<p>You can now create the <code>Istio Gateways</code> for Dev:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">svc-dev-gateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>: <span style="color:#ae81ff">ingressgateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">servers</span>:  
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">port</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https-443-svc-dev  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTPS  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">SIMPLE  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serverCertificate</span>: <span style="color:#ae81ff">/etc/istio/ingressgateway-certs/cert-svc.dev.domain.com.crt  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">privateKey</span>: <span style="color:#ae81ff">/etc/istio/ingressgateway-certs/cert-svc.dev.domain.com.key  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;svc.dev.domain.com&#34;</span>
</span></span></code></pre></div><p>And for Prod :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">svc-prod-gateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>: <span style="color:#ae81ff">ingressgateway  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">servers</span>:  
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">port</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https-443-svc-prod  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTPS  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">SIMPLE  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serverCertificate</span>: <span style="color:#ae81ff">/etc/istio/ingressgateway-certs/cert-svc.prod.domain.com.crt  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">privateKey</span>: <span style="color:#ae81ff">/etc/istio/ingressgateway-certs/cert-svc.prod.domain.com.key  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:  
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;svc.prod.domain.com&#34;</span>
</span></span></code></pre></div><p>Add your <code>VirtualServices</code> as usual and you&rsquo;re done !</p>
<p>One note though :<br>
As of now, Istio Ingress Gateway is not able to detect when a “file” (a Certificate) is updated in the <code>Secret</code>.<br>
That means that even if you <code>Secret</code> will always be up to date when Cert-Manager renew some certs, Istio will not pick them up.<br>
The solution (not part of this blog) is to either :</p>
<ul>
<li>update the <code>Gateway</code> resource (maybe an update is not enough and you need to delete/create it again, will have to check that in another post)</li>
<li>trigger a reload of <code>Envoy</code> by calling it’s internal API</li>
</ul>
<p>Istio’s team is supposed to address that soon.</p>
<h3 id="final-words">Final words</h3>
<p>I’m really questioning the CNCF influence on many projects related to K8s lately.</p>
<p>K8s and micro-services are all about fast iteration, agility, automation…<br>
I’m not saying we can’t step back and think for some time. It’s good to have a clear plan, settle an API and support it.<br>
But it’s also fine to settle on a V1, improve it and reach a V2, even if that imply API changes.</p>
<p>It’s also good to admit things are missing in an API. Labels are a key component to the whole K8s ecosystem. Not having them is Cert-Manager is not a decision, it’s a lack of feature, whatever API you support.</p>
<p>Of course it’s my point of view, and I still thank all the people working hard on these projects. We need them. They are unreplaceable.<br>
Just keep in mind that APIs are not written in stone. You’re allowed to break your API when going from V1 to V2.</p>
<p>Also remember that all this work is a patch on the current implementation of Cert-Manager and Istio Ingress Gateway. As soon as something new comes in, like using an SSL backend storage (maybe Ashicorp Vault ?) or a Gateway SSL management by the Istio Backplane… you’ll be able to trash all this !</p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://piratemakers.ca/tags/devops/">devops</a></span>
        <span class="tag"><a href="https://piratemakers.ca/tags/servicemesh/">servicemesh</a></span>
        <span class="tag"><a href="https://piratemakers.ca/tags/kubernetes/">kubernetes</a></span>
        <span class="tag"><a href="https://piratemakers.ca/tags/dev/">dev</a></span>
        <span class="tag"><a href="https://piratemakers.ca/tags/golang/">golang</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        3353 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2018-11-07 12:38
        

         
          
            
              (Last updated: 2023-12-01 14:31)
            
          
        
      </p>
        <p>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit">
            <circle cx="12" cy="12" r="4"></circle>
            <line x1="1.05" y1="12" x2="7" y2="12"></line>
            <line x1="17.01" y1="12" x2="22.96" y2="12"></line>
          </svg>

          <a href="1ab993c2d9f5b7b58edda6893280e093b620e8db" target="_blank" rel="noopener">1ab993c</a>
          @ 2023-12-01
        </p>
    </div>
      <hr />
      <div class="sharing-buttons">
        
<a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on facebook">
  <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter">
  <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
      <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;caption=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;canonicalUrl=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on tumblr">
  <div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small">
    <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093 0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941 0 9.999 0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="mailto:?subject=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;body=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_self" rel="noopener" aria-label="" title="Share via email">
  <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f&amp;media=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f;description=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge" target="_blank" rel="noopener" aria-label="" title="Share on pinterest">
  <div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f&amp;title=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;summary=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;source=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on linkedin">
  <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f&amp;resubmit=true&amp;title=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge" target="_blank" rel="noopener" aria-label="" title="Share on reddit">
  <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f;title=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge" target="_blank" rel="noopener" aria-label="" title="Share on xing">
  <div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="whatsapp://send?text=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge%20https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on whatsapp">
  <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f&amp;t=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge" target="_blank" rel="noopener" aria-label="" title="Share on hacker news">
  <div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=Istio%201.0.2%20%28Envoy%29%20%2b%20Cert-Manager%20%2b%20Let%e2%80%99s%20Encrypt%20for%20TLS%20%2b%20Certificate%20Merge&amp;url=https%3a%2f%2fpiratemakers.ca%2fposts%2f2018%2f11%2fistio-1.0.2-envoy--cert-manager--lets-encrypt-for-tls--certificate-merge%2f" target="_blank" rel="noopener" aria-label="" title="Share on telegram">
  <div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </div>
  </div>
</a>

      </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://piratemakers.ca/posts/2019/05/istio-1.1.7--lets-encrypt-working/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Istio 1.1.7 &#43; Let’s Encrypt : WORKING !</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://piratemakers.ca/posts/2018/06/istio-0.8.0-envoy--cert-manager--lets-encrypt-for-tls/">
                    <span class="button__text">Istio 0.8.0 (Envoy) &#43; Cert-Manager &#43; Let’s Encrypt for TLS</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    
      
        <div id="comments">
          <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "piratemakers-ca" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      
    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span><a href="https://piratemakers.ca/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
            <span>Pirate Makers™</span>
        </div>
    </div>
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://piratemakers.ca/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag&#43;XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script>




    </body>
</html>
